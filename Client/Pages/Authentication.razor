@page "/authentication/{action}"
@using Concerto.Client.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@inject IChatService ChatService
@inject IUserService UserService
@inject NavigationManager Navigation

<RemoteAuthenticatorView Action="@Action" OnLogOutSucceeded="OnLogOutSucceeded" OnLogInSucceeded="OnLogInSucceeded" />

@code {
	[CascadingParameter]
	private Task<AuthenticationState>? authenticationStateTask { get; set; }

	[Parameter]
	public string? Action { get; set; }

	async Task OnLogInSucceeded() {
		if (authenticationStateTask == null) return;
		UserService.SetAuthenticationState(await authenticationStateTask);
		await UserService.FetchUserId();
		if (UserService.IsLoggedIn)
			await ChatService.ConnectToChatAsync();
	}
	async Task OnLogOutSucceeded()
	{
		UserService.SetAuthenticationState(null);
		await ChatService.DisconnectAsync();
		Navigation.NavigateTo("");
	}
}
