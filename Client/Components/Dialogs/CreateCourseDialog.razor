@using Concerto.Client.Services
@using Concerto.Shared.Models.Dto
@using Concerto.Client.Components.Input
@inject IDialogService DialogService
@inject ICourseService CourseService
@inject ISnackbar Snackbar
@inject HttpClient Http
@inherits DialogAutoFullscreen


<MudDialog Class="" Style="max-height: 100vh; overflow:auto;" ContentStyle="" ClassContent="d-flex flex-column">
	<DialogContent>
		<MudContainer Style="min-height: 300px; min-width: 550px; overflow-y: scroll">
			<MudTextField Variant="Variant.Outlined" Class="mb-2" @bind-Value="_courseName" T="string" Label="Course name" Margin="Margin.Dense"></MudTextField>
			<CourseMemberPicker @bind-SelectedUsers="_members" Style="@PickerStyle" />
        </MudContainer>
	</DialogContent>
	<DialogActions>
		<MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="Cancel">Cancel</MudButton>
		<MudButton Color="Color.Success" Variant="Variant.Filled" OnClick="Submit">Ok</MudButton>
	</DialogActions>
</MudDialog>


@code {
	private string? _courseName;

	private HashSet<User> _members = new(new UserIdEqualityComparer());

	string PickerHeight => !IsFullScreen ? "max-height:calc(100vh - 210px);" : "height:calc(100vh - 215px);";
	string PickerStyle => $"{PickerHeight} min-height: 300px;";



	private async Task Submit()
	{
		if (string.IsNullOrEmpty(_courseName))
		{
			Snackbar.Add("Course name cannot be empty", Severity.Error);
			return;
		}

	// Move to course manager
		var request = new CreateCourseRequest
		{
			Name = _courseName,
			Members = _members.Select(m => new CourseUser(m.Id, CourseUserRole.Member))
		};

		try
		{
			var newCourseId = await CourseService.CreateCourseForCurrentUserAsync(request);
			Snackbar.Add("Course created", Severity.Success);
			Dialog.Close(DialogResult.Ok(newCourseId));
		}
		catch
		{
			Snackbar.Add("Failed to create course", Severity.Error);
		}
	}

	void Cancel()
	{
		Dialog.Cancel();
	}

}