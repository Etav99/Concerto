@using Concerto.Client.Extensions
@using Concerto.Client.Services;
@using Concerto.Shared.Models.Dto
@using System.Net.Http.Headers
@inject ISnackbar Snackbar
@inject HttpClient Http
@inject IAppSettingsService AppSettingsService
@inject IDialogService DialogService
@inject IStorageService StorageService

<MudDialog>
	<DialogContent>
		<MudStack Style="width: 100%">
			<MudFileUpload T="IReadOnlyList<IBrowserFile>" OnFilesChanged="OnInputFileChanged" Hidden="false" Class="flex-1" InputClass="absolute mud-width-full mud-height-full overflow-hidden z-20" InputStyle="opacity:0"
						   @ondragenter="@SetDragClass" @ondragleave="@ClearDragClass" @ondragend="@ClearDragClass">
				<ButtonTemplate>
					<MudPaper Height="300px" Outlined="true" Class="@DragClass">
						<MudText Typo="Typo.h6">Drag and drop files here or click</MudText>
						@foreach (var file in _fileNames)
						{
							<MudChip Color="Color.Dark" Text="@file" />
						}
					</MudPaper>
				</ButtonTemplate>
			</MudFileUpload>
		</MudStack>
	</DialogContent>

	<DialogActions>
		<MudButton OnClick="Upload" Disabled="@(!_fileNames.Any())" Color="Color.Primary" Variant="Variant.Filled">Upload</MudButton>
		<MudButton OnClick="Clear" Disabled="@(!_fileNames.Any())" Color="Color.Error" Variant="Variant.Filled">Clear</MudButton>
		<MudButton OnClick="Cancel">Cancel</MudButton>
	</DialogActions>
</MudDialog>

@code {

	[CascadingParameter]
	MudDialogInstance Dialog { get; set; } = null!;

	[Parameter]
	public long FolderId { get; set; }

	private static string DefaultDragClass = "relative rounded-lg border-2 border-dashed pa-4 mt-4 mud-width-full mud-height-full z-10";
	private string DragClass = DefaultDragClass;
	private List<string> _fileNames = new();
	private IReadOnlyList<IBrowserFile> _files = new List<IBrowserFile>();

	private void OnInputFileChanged(InputFileChangeEventArgs e)
	{
		ClearDragClass();
		_files = e.GetMultipleFiles();
		_fileNames = _files.Select(f => f.Name).ToList();
	}

	private async Task Clear()
	{
		_fileNames.Clear();
		ClearDragClass();
		await Task.Delay(100);
	}


	private void SetDragClass()
	{
		DragClass = $"{DefaultDragClass} mud-border-primary";
	}

	private void ClearDragClass()
	{
		DragClass = DefaultDragClass;
	}

	void Cancel()
	{
		Dialog.Cancel();
	}

	private void Upload()
	{
		StorageService.QueueFilesToUpload(FolderId, _files);
		Dialog.Close();
	}
}


