@using Concerto.Shared.Models.Dto
@using Concerto.Client.Extensions
@using Concerto.Client.Services
@using Concerto.Client.Components.Lists
@inject ICourseService CourseService
@inject IUserService UserService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

@if (Loading)
{
	<MudSkeleton Animation="Animation.Wave" SkeletonType="SkeletonType.Rectangle" Width="100%" Height="100%"></MudSkeleton>
}
else
{
	<div style="display: grid;grid-row-gap: 2px; grid-template-rows: min-content min-content min-content 1fr; height: 100%; overflow: auto">
		<MudStack Row="true" Style="background-color: var(--mud-palette-default)" Justify="Justify.SpaceBetween">
			<MudButtonGroup OverrideStyles="false">
				<MudButton OnClick="Discard" Disabled="!Changed" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Restore" Color="Color.Error">Discard</MudButton>
				<MudButton OnClick="Save" Disabled="!Changed || !_courseNameValid" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Save" Color="Color.Success">Save</MudButton>
			</MudButtonGroup>
			<MudButtonGroup OverrideStyles="false">
				<MudButton OnClick="Delete" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Delete" Color="Color.Error">Delete</MudButton>
			</MudButtonGroup>
		</MudStack>


		<MudPaper Class="d-flex align-center pa-2" Elevation="0" Outlined="true">
			<MudIcon Class="mr-2" Icon="@Icons.Material.Filled.Person" Title="Role" />
			<MudText>Your role: @CourseSettings?.CurrentUserRole.ToDisplayString()</MudText>
		</MudPaper>

		<MudPaper Elevation="0">
			<MudForm @ref="_courseNameForm" @bind-IsValid="@_courseNameValid">
				<MudTextField T="string" Adornment="Adornment.Start" AdornmentIcon="@Icons.Filled.Title" Immediate="true" Variant="Variant.Outlined"
						  Validation="new Func<string, string?>(Validation.NotEmpty)" @bind-Value="Request.Name" T="string" Label="Course name"
						  Margin="Margin.Dense" />
			</MudForm>
		</MudPaper>

		<CourseMemberManager SelectedCourseUsers="Request.Members" SelectedCourseUsersChanged="() => StateHasChanged()"
						 ExistingCourseUsers="CurrentMembers"
						 AvailableCourseUsers="AvailableMembers"
						 Users="Users" Style=" overflow: auto" />
	</div>

}



@code {

	[Parameter]
	public long CourseId { get; set; }

	[Parameter]
	public EventCallback OnCourseDeleted { get; set; }

	[Parameter]
	public EventCallback OnCourseUpdated { get; set; }


	MudForm? _courseNameForm;
	private bool _courseNameValid = false;

	CourseSettings? CourseSettings { get; set; }

	// Form
	private UpdateCourseRequest Request { get; set; } = null!;


	bool Changed => Request.Name != CourseSettings!.Name || !ChangeDetectionSet.SetEquals(Request.Members);
	private HashSet<CourseUser> ChangeDetectionSet { get; set; } = null!;
	private HashSet<CourseUser> CurrentMembers { get; set; } = null!;

	private Dictionary<long, User> Users { get; set; } = new();
	private HashSet<CourseUser> AvailableMembers { get; set; } = null!;


	bool Loading => CourseSettings is null || Request is null || CurrentMembers is null;

	protected override async Task OnInitializedAsync()
	{
		await Initialize();
	}

	protected override async Task OnParametersSetAsync()
	{
		if (CourseSettings is null || CourseSettings.Id != CourseId)
		{
			await Initialize();
		}
	}

	private async Task Initialize()
	{
		CourseSettings = null;
		CourseSettings = await CourseService.GetCourseSettingsAsync(CourseId);
		var users = await UserService.GetUsersAsync();
		Users = users.ToDictionary(u => u.Id);

		CurrentMembers = CourseSettings.Members.ToHashSet(new CourseUserIdEqualityComparer());
		var nonMembers = users.Select(u => new CourseUser(u.Id, CourseUserRole.Member)).Except(CurrentMembers);

		ChangeDetectionSet = CurrentMembers.ToHashSet();


		var _initialSelectedMembers = CurrentMembers.Select(cu => cu with { }).ToHashSet(new CourseUserIdEqualityComparer());
		AvailableMembers = _initialSelectedMembers.ToHashSet(new CourseUserIdEqualityComparer());
		AvailableMembers.UnionWith(nonMembers);

		Request = new UpdateCourseRequest
		{
			CourseId = CourseSettings.Id,
			Name = CourseSettings.Name,
			Description = CourseSettings.Description,
			Members = _initialSelectedMembers
		};
	}

	private async Task Discard()
	{
		await Initialize();
	}

	private async Task Save()
	{
		_courseNameForm?.Validate();
		if (!_courseNameValid) return;

		CourseSettings = null;
		try
		{
			await CourseService.UpdateCourseAsync(Request);
			Snackbar.Add("Course updated", Severity.Success);
			OnCourseUpdated.InvokeAsync().AndForget();
		}
		catch
		{
			Snackbar.Add("Failed to update course", Severity.Error);
		}
		await Initialize();
	}

	private async Task Delete()
	{
		if (!await DialogService.ShowDeleteConfirmationDialog("Delete course", "course", CourseSettings!.Name, true)) return;
		try
		{
			await CourseService.DeleteCourseAsync(CourseSettings.Id);
			Snackbar.Add($"{CourseSettings!.Name} deleted", Severity.Success);
			await OnCourseDeleted.InvokeAsync();
		}
		catch
		{
			Snackbar.Add($"Failed to delete course {CourseSettings!.Name}.", Severity.Error);
		}
	}

}