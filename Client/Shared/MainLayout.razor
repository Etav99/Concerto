@inherits LayoutComponentBase

@using Blazored.LocalStorage
@using Concerto.Client.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@inject NavigationManager Navigation
@inject SignOutSessionStateManager SignOutManager
@inject IChatService ChatService
@inject IContactService ContactsManager
@inject IUserService UserService
@inject ISnackbar Snackbar
@inject ISyncLocalStorageService LocalStorage

<MudThemeProvider @bind-IsDarkMode="@DarkMode" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout Style="height:100vh;">
	<MudAppBar Elevation="0">
		<MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
		<MudText Typo="Typo.h4">Concerto</MudText>
		<MudSpacer />
		<MudSwitch T="bool" Checked="@DarkMode" CheckedChanged="@(async (b) => await toggleDarkMode(b))" ThumbIcon="@(DarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)">Toggle theme</MudSwitch>
		<AuthorizeView>
			<Authorized>
				<MudText Class="mx-4">Welcome, @context.User.Identity.Name!</MudText>
				<MudStack Row="true">
					<MudButton Variant="Variant.Text" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Person" OnClick="BeginLogout">Log out</MudButton>
				</MudStack>
			</Authorized>
			<NotAuthorized>
				<MudAlert Class="mx-4" Variant="Variant.Filled" Severity="Severity.Info">Please log in.</MudAlert>
				<MudStack Row="true">
					<MudButton Href="authentication/login" Variant="Variant.Text" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Login">Sign in</MudButton>
				</MudStack>
			</NotAuthorized>
		</AuthorizeView>
	</MudAppBar>
	<MudDrawer @bind-Open="_drawerOpen" Elevation="1">
		<MudDrawerHeader>
			<MudText Typo="Typo.h6">Menu</MudText>
		</MudDrawerHeader>
		<NavMenu />
	</MudDrawer>
	<MudMainContent Style="height: 100%">
		<MudContainer MaxWidth="@(Navigation.Uri.Contains("session") ? MaxWidth.ExtraLarge : MaxWidth.Large)" Class="pa-16" Style="height: 100%;">
			<CascadingValue TValue="bool" Value="DarkMode">
				@Body
			</CascadingValue>
		</MudContainer>
	</MudMainContent>
</MudLayout>

@code {
	[CascadingParameter]
	private Task<AuthenticationState>? authenticationStateTask { get; set; }

	bool DarkMode { get; set; } = false;
	bool _drawerOpen = true;

	void DrawerToggle()
	{
		_drawerOpen = !_drawerOpen;
	}

	private async Task BeginLogout(MouseEventArgs args)
	{
		await SignOutManager.SetSignOutState();
		Navigation.NavigateTo("authentication/logout");
	}

	private void LogIn()
	{
		Navigation.NavigateTo("authentication/login");
	}

	private async Task toggleDarkMode(bool darkMode)
	{
		DarkMode = darkMode;
		LocalStorage.SetItem("darkMode", DarkMode);
	}

	protected override void OnInitialized()
	{
		if (LocalStorage.ContainKey("darkMode"))
		{
			DarkMode = LocalStorage.GetItem<bool>("darkMode");
		}
		else
		{
			LocalStorage.SetItem("darkMode", DarkMode);
		}
	}

	protected override async Task OnInitializedAsync()
	{
		if (authenticationStateTask == null) return;
		UserService.SetAuthenticationState(await authenticationStateTask);
		await UserService.FetchUserId();
		if (UserService.IsLoggedIn)
			await ChatService.ConnectToChatAsync();
	}
}